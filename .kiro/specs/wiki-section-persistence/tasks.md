# Implementation Plan: wiki-section-persistence

## Task Overview

この実装計画は、`/ai-wiki/init`コマンドを拡張し、既存の`wiki_structure.json`ファイルから前回のセクション情報を読み込み、その構成を維持しながらWiki構造を更新する機能を実装します。

- [x] 1. 既存のwiki_structure.jsonの読み込みと検証処理を実装する
- [x] 1.1 Step 1とStep 2の間に新しいステップ（Step 1.5）を追加する
  - 出力先ディレクトリを削除する前に、`[出力先ディレクトリ]/wiki_structure.json`ファイルの存在を確認する処理を追加
  - 既存の`init.md`コマンド定義のStep 1の後に、Step 1.5として挿入
  - 既存のステップ番号（Step 2-5）は変更しない
  - _Requirements: 1.1, 1.6_

- [x] 1.2 既存のwiki_structure.jsonファイルの読み込み処理を実装する
  - `read_file`ツールを使用して、`[出力先ディレクトリ]/wiki_structure.json`ファイルを読み込む
  - ファイルが存在する場合は、JSONデータを変数として設定
  - ファイルが存在しない場合は、新規作成モードとして処理を続行するフラグを設定
  - _Requirements: 1.2, 1.3_

- [x] 1.3 JSONファイルの構文検証処理を実装する
  - 既存JSONファイルが存在する場合、Dockerコンテナ（`python:3-alpine`）を使用してJSON構文を検証
  - `make.md`コマンドのJSON検証パターンを再利用
  - 検証に失敗した場合はエラーメッセージを報告し、処理を中断
  - 検証が成功した場合は、次のステップに進む
  - _Requirements: 1.4_

- [x] 1.4 既存JSONデータからセクション情報を抽出する処理を実装する
  - 読み込んだJSONデータから`sections`配列を抽出し、変数として設定
  - 読み込んだJSONデータから`pages`配列を抽出し、変数として設定
  - 既存の`project_root`を抽出し、変数として設定（存在する場合）
  - セクションIDとページIDのマッピング情報を保持するデータ構造を作成
  - _Requirements: 1.5_

- [x] 2. 構成類似度評価と判断ロジックを実装する
- [x] 2.1 構成類似度評価アルゴリズムを設計・実装する
  - `project_root`の一致を必須条件として評価
  - セクション数の一致度を評価（既存セクション数と新規分析で推測されるセクション数の比較）
  - ページ数の一致度を評価（既存ページ数と新規分析で推測されるページ数の比較）
  - 階層構造の一致度を評価（`subsections`配列の構造比較）
  - 類似度の計算方法を定義（例：`project_root`一致=必須、セクション数・ページ数の一致率を計算）
  - 類似度の閾値を定義（例：類似度70%以上で構成維持、それ以下で新規構成採用）
  - 設計レビューで指摘された懸念事項を明確化するタスク
  - _Requirements: 4.1, 4.2_

- [x] 2.2 構成維持の判断ロジックを実装する
  - 構成類似度評価の結果に基づいて、構成維持の判断を実行
  - 類似度が高い場合（`project_root`が一致し、セクション構造が類似している場合）は、既存のセクション構成を維持するフラグを設定
  - 類似度が低い場合（`project_root`が異なる、または内容が大きく乖離する場合）は、新規構成を採用するフラグを設定
  - 判断結果をユーザーに報告するメッセージを生成
  - _Requirements: 4.3, 4.4, 4.5_

- [x] 3. ページIDマッチングロジックを実装する
- [x] 3.1 ページIDマッチングの基準を定義・実装する
  - 既存のページIDと新規分析結果のページIDをマッチングする基準を定義
  - マッチング基準の候補を検討（ページタイトルの一致、`relevant_files`の一致、または両方の組み合わせ）
  - 最適なマッチング基準を選択し、実装
  - マッチングが失敗した場合のフォールバック戦略を定義（例：新規ページとして扱う）
  - 設計レビューで指摘された懸念事項を明確化するタスク
  - _Requirements: 3.2, 3.3_

- [x] 3.2 既存ページIDと新規分析結果のマッチング処理を実装する
  - 既存のページIDとセクションIDのマッピング情報を使用して、新規分析結果のページと既存ページをマッチング
  - マッチングが成功した場合、既存の`parent_section`と`related_pages`を保持
  - マッチングが失敗した場合、新規ページとして扱い、既存のセクション構造に基づいて適切な`parent_section`を割り当て
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 3.3 既存ページが新規分析で検出されない場合の処理を実装する
  - 既存のページIDが新規分析結果に存在しない場合、そのページを新しいWiki構造から除外する処理を実装
  - 除外されたページの情報をログに記録（オプション）
  - _Requirements: 3.6_

- [x] 4. セクション構成の維持処理を実装する
- [x] 4.1 既存のセクション構成を保持する処理を実装する
  - 既存の`sections`配列の構造を維持する処理を実装
  - 既存のセクションIDを保持する処理を実装
  - 既存のセクションタイトルを保持する処理を実装
  - 既存の`subsections`配列の階層構造を維持する処理を実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4.2 既存セクション構成への新規ページ追加の手順を実装する
  - 既存のセクション構成を参照して、新しいページを適切なセクションに配置する処理を実装
  - 既存セクションの`pages`配列に新規ページIDを追加する処理を実装
  - 新規ページの`parent_section`プロパティを既存のセクションIDに設定する処理を実装
  - 設計レビューで指摘された懸念事項を明確化するタスク
  - _Requirements: 2.7, 3.4_

- [x] 4.3 新しいセクションが必要な場合の処理を実装する
  - 新規分析結果で既存のセクション構成にないセクションが必要な場合の処理を実装
  - 既存のセクション構成を優先し、必要に応じて新規セクションを追加する処理を実装
  - 新規セクションのID生成ロジックを実装（既存のセクションIDと重複しないようにする）
  - _Requirements: 2.5_

- [x] 4.4 構成が大きく乖離する場合の処理を実装する
  - 既存のセクション構成と新規分析結果が大きく乖離する場合、構成を維持しなくてもよい処理を実装
  - 新規構成を採用する場合の処理を実装
  - _Requirements: 2.6_

- [x] 5. Wiki構造生成処理を拡張する
- [x] 5.1 Step 4のWiki構造生成処理を拡張する
  - 既存のセクション情報を参照してWiki構造を生成する処理を追加
  - 既存のセクション構成を維持した状態で、新しいページを生成する処理を実装
  - 既存のページIDとマッチングしたページには、既存の`parent_section`と`related_pages`を適用
  - 新規ページには、既存のセクション構造に基づいて適切な`parent_section`を割り当て
  - _Requirements: 2.7, 3.2, 3.3, 3.4, 3.5_

- [x] 5.2 生成されたWiki構造の整合性を検証する処理を実装する
  - 生成されたWiki構造のセクションIDとページIDの一意性を確認
  - ページの`parent_section`が有効なセクションIDを参照していることを確認
  - セクションの`pages`配列内のページIDが有効なページIDを参照していることを確認
  - セクションの`subsections`配列内のセクションIDが有効なセクションIDを参照していることを確認
  - _Requirements: 2.1, 3.1_

- [x] 6. 更新されたwiki_structure.jsonの保存処理を実装する
- [x] 6.1 生成されたWiki構造をJSONファイルに保存する処理を実装する
  - 生成されたWiki構造を`[出力先ディレクトリ]/wiki_structure.json`形式で保存する処理を実装
  - 既存のセクション情報を維持した状態でJSONファイルを保存する（構成維持が選択された場合）
  - ファイル書き込みに失敗した場合はエラーメッセージを報告し、処理を中断
  - _Requirements: 5.1, 5.2_

- [x] 6.2 保存されたJSONファイルの構文検証を実装する
  - Dockerコンテナ（`python:3-alpine`）を使用してJSONファイルの構文検証を実行
  - 既存の`init.md`コマンドのJSON検証パターンを再利用
  - 検証に失敗した場合はエラーメッセージを報告し、処理を中断
  - 検証が成功した場合、完了通知をユーザーに報告
  - _Requirements: 5.3_

- [x] 6.3 次回のコマンド実行時に利用可能にする処理を確認する
  - 保存された`wiki_structure.json`ファイルが次回の`/ai-wiki/init`コマンド実行時に利用可能であることを確認
  - ファイルパスとアクセス権限を確認
  - _Requirements: 5.5_

- [x] 7. エラーハンドリングとユーザー通知を実装する
- [x] 7.1 既存JSONファイルが存在しない場合の処理を実装する
  - 既存の`wiki_structure.json`が存在しない場合、新規作成モードとして処理を続行する処理を実装
  - 新規作成モードであることをユーザーに通知（オプション）
  - _Requirements: 1.3_

- [x] 7.2 JSON構文エラーの処理を実装する
  - JSON構文が無効な場合、エラーメッセージを報告し、処理を中断する処理を実装
  - エラーメッセージには具体的な問題点を含める
  - 新規作成モードにフォールバックするオプションを検討（設計レビューで指摘されたリスク対応）
  - _Requirements: 1.4_

- [x] 7.3 構成維持の判断結果をユーザーに報告する処理を実装する
  - 既存構成を維持した場合、その旨をユーザーに報告
  - 新規構成を採用した場合、その旨をユーザーに報告
  - 報告メッセージには判断の根拠（類似度評価結果など）を含める
  - _Requirements: 4.5_

