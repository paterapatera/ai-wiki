# Gap Analysis: make-wiki-sidebar

## Analysis Summary

- **Scope**: `/ai-wiki/make`コマンドを拡張し、Wikiページ生成時にサイドバーファイル（`_sidebar.md`）も自動生成する機能を実装
- **Key Challenges**: 
  - 既存の`make.md`はWikiページ生成のみで、サイドバー生成機能が未実装
  - サイドバーのMarkdown形式とナビゲーション階層の実装方法を決定する必要がある
  - セクション構造をサイドバーに反映するロジックの実装が必要
- **Recommendations**: 
  - 既存の`make.md`を拡張するアプローチ（Option A）を推奨
  - 既存のパターン（ファイル書き込み、エラーハンドリング）を再利用
  - サイドバー生成をWikiページ生成の完了後に実行する統合アプローチ

## Document Status

この分析は`.kiro/settings/rules/gap-analysis.md`のフレームワークに従って実施されました。

## Current State Investigation

### Domain-Related Assets

**既存のコマンド定義ファイル**:
- `.cursor/commands/ai-wiki/make.md`: Wikiページ生成コマンド（既に実装済み）
  - `wiki_structure.json`の読み込みと検証機能が実装済み
  - 出力先ディレクトリの指定機能が実装済み
  - 各ページの生成ループ処理が実装済み
  - セクション構造の解析機能が実装済み
  - ファイル書き込み機能（`write`ツール）が使用されている
  - エラーハンドリングパターンが確立されている
  - **ギャップ**: サイドバーファイル（`_sidebar.md`）の生成機能が未実装

**既存のデータ構造**:
- `.wiki/wiki_structure.json`: 既存のJSON構造ファイル（実例あり）
  - `title`, `description`, `sections`, `pages`を含む
  - 各ページには`id`, `title`, `description`, `importance`, `relevant_files`, `related_pages`, `parent_section`が含まれる
  - セクションには`id`, `title`, `pages`, `subsections`が含まれる
  - **利用可能**: サイドバー生成に必要な情報は全て含まれている

**既存の出力パターン**:
- Wikiページは`{page-id}.md`形式で出力先ディレクトリに保存される（フラット構造）
- ファイル名はページIDをそのまま使用（無効文字は`-`に置換）
- Markdown形式でUTF-8エンコーディング

### Conventions and Patterns

**コマンド定義の構造**:
- `<meta>`セクション: `description`, `argument-hint`を含む
- `<background_information>`セクション: コマンドの目的と機能の説明
- `<instructions>`セクション: ステップバイステップの処理指示
- `<Tool Guidance>`セクション: 使用するツールの説明
- `<Output Description>`セクション: 出力の説明
- `<Safety & Fallback>`セクション: エラーハンドリング

**ツール使用パターン**:
- `read_file`: ファイル読み込み（`wiki_structure.json`の読み込みで使用）
- `write`: ファイル書き込み（Wikiページの保存で使用、サイドバー生成でも再利用可能）
- `run_terminal_cmd`: ディレクトリ操作、JSON検証（Docker使用）
- 変数展開: `${variable}`形式で動的変数を使用

**エラーハンドリングパターン**:
- エラー発生時は処理を中断し、明確なエラーメッセージを日本語で報告
- 部分的な失敗時は成功した処理は保存し、失敗した処理についてのみエラーを報告
- ファイル書き込み失敗時はエラーメッセージを報告し、処理を継続または中断（実装方針による）

**出力パターン**:
- 日本語での出力（`spec.json.language = "ja"`）
- Markdown形式でのファイル生成
- ファイルパスはワークスペースルートからの相対パス

### Integration Surfaces

**既存の統合ポイント**:
- `wiki_structure.json`の読み込み: 既に`make.md`で実装済み（`${wikiStructure}`, `${sections}`, `${pages}`変数が利用可能）
- 出力先ディレクトリ: 既に`make.md`で実装済み（`${outputDir}`変数が利用可能）
- ファイル書き込み: `write`ツールが既に使用されている（サイドバー生成でも再利用可能）
- セクション構造の解析: 既に`make.md`で実装済み（`${sectionMap}`変数が利用可能）

## Requirements Feasibility Analysis

### Technical Needs from Requirements

**Requirement 1: サイドバーファイルの生成**
- **既存資産**: `write`ツールでファイル書き込み機能は利用可能、`${outputDir}`変数が利用可能
- **ギャップ**: サイドバー生成処理の実装が必要
- **制約**: なし

**Requirement 2: セクション構造に基づくナビゲーション階層**
- **既存資産**: `wiki_structure.json`にセクション構造が定義済み、`${sections}`配列と`${sectionMap}`が利用可能
- **ギャップ**: セクション構造をMarkdown形式のサイドバーに変換するロジックが必要
- **制約**: なし

**Requirement 3: ページリンクの生成**
- **既存資産**: ページIDからファイルパスへのマッピングロジックが既に実装済み（Wikiページファイルは`{page-id}.md`形式で保存）
- **ギャップ**: サイドバー内でページリンクを生成する処理が必要（サイドバーでは`.md`拡張子を含めない形式`{page-id}`を使用）
- **制約**: サイドバーのリンク形式は`.md`拡張子を含めない形式で生成する必要がある

**Requirement 4: サイドバーのMarkdown形式**
- **既存資産**: Markdown形式でのファイル生成パターンが確立
- **ギャップ**: サイドバー専用のMarkdown形式（セクション見出し、リスト構文）の実装が必要
- **形式が確定**: 以下の形式を使用
  - トップレベルのページリンク: `- [Page Title](page-id)`（`.md`拡張子は含めない）
  - サブレベルのページリンク: `  - [Page Title](page-id)`（2スペースのインデント）
  - セクション見出し: `## Section Title`
- **制約**: リンクURLには`.md`拡張子を含めない

**Requirement 5: 既存コマンドとの統合**
- **既存資産**: `make.md`の処理フローが確立済み
- **ギャップ**: サイドバー生成処理を既存の処理フローに統合する必要がある
- **制約**: 既存のWikiページ生成処理に影響を与えないようにする必要がある

**Requirement 6: エラーハンドリングと検証**
- **既存資産**: エラーハンドリングパターンが確立済み
- **ギャップ**: サイドバー生成専用のエラーハンドリングが必要
- **制約**: サイドバー生成の失敗がWikiページ生成に影響を与えないようにする必要がある

**Requirement 7: サイドバーの構造とフォーマット**
- **既存資産**: `wiki_structure.json`の`title`が利用可能
- **ギャップ**: サイドバーの構造とフォーマットの詳細設計が必要
- **研究が必要**: サイドバーの先頭にWikiタイトルを含めるかどうかの決定
- **制約**: なし

### Complexity Signals

- **Simple**: ファイル書き込み、Markdown形式の生成
- **Algorithmic Logic**: セクション構造からMarkdown形式への変換、ページリンクの生成、階層構造のインデント処理
- **Workflows**: サイドバー生成処理を既存の処理フローに統合
- **External Integrations**: なし

## Implementation Approach Options

### Option A: Extend Existing make.md

**概要**: 既存の`make.md`を拡張して、Wikiページ生成の完了後にサイドバー生成処理を追加する。

**拡張するファイル**:
- `.cursor/commands/ai-wiki/make.md`

**拡張内容**:
1. `<instructions>`セクションに新しいステップを追加:
   - Step 6: サイドバーファイルの生成（Wikiページ生成の完了後）
     - セクション構造を解析してサイドバーのMarkdownコンテンツを生成
     - 各セクションの`title`をセクション見出しとして使用
     - 各セクションの`pages`配列に基づいてページリンクを生成
     - ページIDからファイルパスへのマッピング（`{page-id}`形式、`.md`拡張子は含めない）
     - Markdown形式でサイドバーコンテンツを生成
       - トップレベル: `- [Page Title](page-id)`
       - サブレベル: `  - [Page Title](page-id)`（2スペースのインデント）
     - `write`ツールで`${outputDir}/_sidebar.md`に書き込み
2. `<background_information>`セクションにサイドバー生成機能を追加
3. `<Output Description>`セクションにサイドバーファイルの説明を追加
4. `<Safety & Fallback>`セクションにサイドバー生成のエラーハンドリングを追加

**互換性評価**:
- ✅ 既存のWikiページ生成処理を維持するため、後方互換性の問題なし
- ✅ 既存の変数（`${wikiStructure}`, `${sections}`, `${pages}`, `${outputDir}`）を再利用
- ✅ 既存のパターン（ファイル書き込み、エラーハンドリング）を再利用

**複雑さと保守性**:
- ⚠️ ファイルサイズがさらに大きくなる可能性（既に280行程度）
- ✅ 単一責任の原則は維持（Wiki生成コマンドとしての責任）
- ✅ 既存のパターンを再利用するため、認知負荷は低い

**トレードオフ**:
- ✅ 最小限の新規ファイル、初期開発が速い
- ✅ 既存のパターンとインフラを活用
- ✅ 既存の変数とデータ構造を再利用
- ❌ ファイルサイズが大きくなる可能性
- ❌ 既存のロジックが複雑になる可能性

### Option B: Create New Components

**概要**: サイドバー生成のロジックを別のテンプレートファイルまたはヘルパーコマンドに分離する。

**新規作成するファイル**:
- `.cursor/commands/ai-wiki/make-sidebar.md`: サイドバー生成専用コマンド（非推奨、統合が目的）
- `.kiro/settings/templates/wiki/sidebar.md`: サイドバー生成のテンプレート（検討可能）

**統合ポイント**:
- `make.md`からサイドバー生成処理を呼び出す（またはテンプレートを読み込む）
- テンプレートファイルは変数展開（`${sections}`, `${pages}`など）をサポート

**責任の境界**:
- `make.md`: Wikiページ生成とサイドバー生成の統合
- `sidebar.md`テンプレート: サイドバーのMarkdown形式の定義

**トレードオフ**:
- ✅ 関心の分離が明確
- ✅ サイドバー生成ロジックのテストが容易
- ✅ 既存コンポーネントの複雑さを軽減
- ❌ より多くのファイルをナビゲートする必要がある
- ❌ テンプレートシステムの設計が必要（変数展開の実装方法）
- ❌ 既存の`make.md`の変数スコープとの統合が複雑になる可能性

### Option C: Hybrid Approach

**概要**: `make.md`を拡張しつつ、サイドバー生成のロジックを明確に分離したセクションとして定義する。

**拡張するファイル**:
- `.cursor/commands/ai-wiki/make.md`: サイドバー生成処理を追加

**分離する部分**:
- サイドバー生成処理: Step 6として明確に分離
- サイドバーのMarkdown形式: 明確に定義された形式で生成

**段階的実装**:
- Phase 1: 基本的なサイドバー生成（セクション構造なし、フラットなページリスト）
- Phase 2: セクション構造に基づく階層的なナビゲーション
- Phase 3: エラーハンドリングの強化、フォーマットの改善

**リスク軽減**:
- 各フェーズで動作確認可能
- 既存のWikiページ生成処理に影響を与えない

**トレードオフ**:
- ✅ 複雑な機能に対するバランスの取れたアプローチ
- ✅ 反復的な改善が可能
- ❌ より複雑な計画が必要
- ❌ 適切に調整されない場合、一貫性の欠如の可能性

## Implementation Complexity & Risk

### Effort: **S (1-3 days)**

**根拠**:
- 既存のパターン（ファイル書き込み、エラーハンドリング）を再利用可能
- 既存の変数（`${wikiStructure}`, `${sections}`, `${pages}`, `${outputDir}`）を再利用可能
- セクション構造からMarkdown形式への変換は比較的シンプルなロジック
- ページリンクの生成ロジックは既存の実装パターンを再利用可能
- サイドバーのMarkdown形式の実装は標準的な形式で比較的シンプル

### Risk: **Low**

**根拠**:
- 既存のパターンに基づいた実装のため、技術的な未知は少ない
- 既存のWikiページ生成処理に影響を与えない設計が可能
- サイドバー生成の失敗がWikiページ生成に影響を与えないようにエラーハンドリング可能
- 標準的なMarkdown形式のため、実装の複雑さは低い
- サイドバーの形式に関する研究項目はあるが、実装をブロックするものではない

## Recommendations for Design Phase

### Preferred Approach: **Option A (Extend Existing make.md)**

**理由**:
1. 既存の変数とデータ構造を直接再利用できる
2. 既存のパターン（ファイル書き込み、エラーハンドリング）を再利用できる
3. 単一ファイルでの完結により、ナビゲーションが容易
4. 初期開発が速い
5. 既存の処理フローに自然に統合できる

**主要な決定事項**:
1. **サイドバーのMarkdown形式**: 標準的な形式を採用
   - セクション見出し: `## Section Title`
   - ページリンク: `- [Page Title](page-id)`（`.md`拡張子は含めない）
   - 階層構造: インデントで表現（サブレベルは2スペースのインデント: `  - [Page Title](page-id)`）
   - 空行: セクション間を空行で区切る
2. **サイドバー生成のタイミング**: Wikiページ生成の完了後（Step 5の後）
   - 既存の変数（`${wikiStructure}`, `${sections}`, `${pages}`, `${outputDir}`）が利用可能
   - エラーが発生してもWikiページ生成に影響を与えない
3. **サイドバーの構造**:
   - オプション: サイドバーの先頭にWikiタイトル（`${wikiStructure.title}`）を含めるかどうか
   - セクション構造: `sections`配列の順序に従う
   - ページ順序: 各セクションの`pages`配列の順序に従う
4. **エラーハンドリング方針**: サイドバー生成の失敗は報告するが、Wikiページ生成の結果には影響を与えない

### Research Items to Carry Forward

1. **サイドバーのMarkdown形式の詳細**:
   - ✅ **確定**: ページリンクの形式は`[Page Title](page-id)`（`.md`拡張子は含めない）
   - ✅ **確定**: 階層構造はインデントで表現（サブレベルは2スペースのインデント）
   - セクション見出しのレベル（`##` vs `###`）の決定
   - サイドバーの先頭にWikiタイトルを含めるかどうかの決定

2. **セクション構造の処理**:
   - `subsections`配列が存在する場合の階層構造の表現方法
   - セクションにページが存在しない場合の処理方法
   - 簡潔ビュー（`sections`配列が存在しない場合）の処理方法

3. **ページリンクの生成**:
   - ✅ **確定**: ページIDからファイルパスへのマッピングは`{page-id}`形式（`.md`拡張子は含めない）
   - ページタイトルが存在しない場合のフォールバック処理
   - リンク先のページが存在しない場合の処理（警告表示 vs リンクスキップ）

## Next Steps

1. **設計フェーズ**: `/kiro/spec-design make-wiki-sidebar`を実行して、技術設計ドキュメントを作成
2. **研究項目の調査**: サイドバーのMarkdown形式、セクション構造の処理、ページリンクの生成の詳細を決定
3. **実装準備**: 設計が承認されたら、`/kiro/spec-tasks make-wiki-sidebar`でタスクを生成

