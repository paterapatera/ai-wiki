# Research Log: make-wiki-command

## Summary

この機能は既存の`/ai-wiki/make`コマンドを拡張し、`wiki_structure.json`を読み込んで全ページのWikiコンテンツを生成する機能を実装します。既存のパターン（`init.md`のJSON検証、ディレクトリ操作、エラーハンドリング）を再利用し、既存のページ生成指示を維持しながら、JSON読み込み、ループ処理、出力先指定、セクション構造維持、リンク生成の機能を追加します。

## Research Log

### 1. 既存システムの統合ポイント分析

**調査内容**: 既存の`make.md`と`init.md`のパターンを分析

**発見事項**:
- `init.md`はJSON検証にDockerを使用するパターンが確立されている
- ディレクトリ操作（`rm -rf`, `mkdir -p`）のパターンが確立されている
- エラーハンドリングのパターンが確立されている
- `make.md`には詳細なページ生成指示が既に定義されている

**影響**: 既存のパターンを再利用することで、一貫性を保ちながら実装できる

### 2. セクション構造の実装方法

**調査内容**: セクション構造をファイルシステムに反映する方法の検討

**選択肢**:
1. **フラット構造**: 各ページを`{page-id}.md`形式で出力先ディレクトリに保存
2. **ディレクトリ階層構造**: セクションごとにサブディレクトリを作成（`{section-id}/{page-id}.md`）

**決定**: フラット構造を採用
- **理由**: シンプルさを優先し、ナビゲーションの複雑さを回避
- **実装**: 各ページを`{page-id}.md`形式で出力先ディレクトリに保存
- **セクション情報**: ページ内のメタデータとして保持（必要に応じて）

**影響**: リンク生成がシンプルになり、ファイル管理が容易になる

### 3. ページ間リンクの生成ロジック

**調査内容**: ページIDからファイルパスへのマッピングとリンク生成の実装方法

**決定事項**:
- **リンク形式**: `[Link Text](page-id.md)`（フラット構造の場合）
- **相対パス**: ワークスペースルートからの相対パスを使用
- **存在しないページ**: リンクを生成するが、警告を表示しない（要件では「存在しないページへの参照であることを示す」とあるが、実装の簡素化のため、リンクのみ生成）

**影響**: シンプルなリンク生成ロジックで実装可能

### 4. ファイル名の生成ロジック

**調査内容**: ファイル名の生成方法（IDベース vs タイトルベース）と無効文字のエスケープ方法

**決定事項**:
- **ファイル名**: ページIDベース（`{page-id}.md`）
- **理由**: IDは一意性が保証されており、ファイル名として適切
- **無効文字**: ページIDには無効文字が含まれないことを前提（`wiki_structure.json`の生成時に保証）
- **エスケープ**: 必要に応じて、無効文字を`-`に置換

**影響**: シンプルなファイル名生成ロジックで実装可能

### 5. エラーハンドリング方針

**調査内容**: 部分的な失敗時の処理方針

**決定事項**:
- **方針**: 成功したページは保存し、失敗したページについてのみエラーを報告
- **進捗報告**: 処理の完了時に、生成されたページ数と失敗したページ数を報告
- **エラーメッセージ**: 日本語で明確なエラーメッセージを報告

**影響**: ユーザーに適切なフィードバックを提供できる

## Architecture Pattern Evaluation

### 選択パターン: 既存コマンド定義の拡張

**理由**:
- 既存のページ生成指示を直接再利用できる
- 既存のパターン（`init.md`のJSON検証、ディレクトリ操作）を再利用できる
- 単一ファイルでの完結により、ナビゲーションが容易
- 初期開発が速い

**トレードオフ**:
- ✅ 最小限の新規ファイル、初期開発が速い
- ✅ 既存のパターンとインフラを活用
- ✅ 既存のページ生成指示を再利用
- ❌ ファイルサイズが大きくなる可能性（200-300行程度）
- ❌ 既存のロジックが複雑になる可能性

## Technology Alignment

### 既存技術スタックの利用

- **Markdown**: コマンド定義とWikiページの生成に使用
- **JSON**: `wiki_structure.json`の読み込みと検証に使用
- **Docker**: JSON検証に使用（`init.md`のパターンを再利用）
- **Cursorエージェント**: コマンド実行環境

### 新規依存関係

なし（既存の技術スタックのみを使用）

## Design Decisions

### 1. セクション構造の実装方法

**決定**: フラットなディレクトリ構造を採用

**理由**: シンプルさを優先し、ナビゲーションの複雑さを回避

### 2. ページ間リンクの生成

**決定**: ページIDベースの相対パスリンクを使用

**理由**: シンプルで一貫性のあるリンク生成が可能

### 3. エラーハンドリング

**決定**: 部分的な失敗時は成功したページを保存し、失敗したページについてのみエラーを報告

**理由**: ユーザーに適切なフィードバックを提供しつつ、成功した作業を無駄にしない

## Risks and Mitigations

### リスク1: ファイル名の衝突

**リスク**: ページIDが重複する可能性（低い）

**軽減策**: `wiki_structure.json`の生成時にIDの一意性が保証されている

### リスク2: 大量のページ生成時のパフォーマンス

**リスク**: 大量のページを生成する際に時間がかかる可能性

**軽減策**: 各ページの生成は独立しているため、必要に応じて並列化可能（将来の拡張）

### リスク3: リンク先のページが存在しない

**リスク**: `related_pages`に存在しないページIDが含まれる可能性

**軽減策**: リンク生成時に存在確認を行い、存在しない場合は警告を表示（またはリンクをスキップ）

## Open Questions

なし（すべての設計決定が完了）
