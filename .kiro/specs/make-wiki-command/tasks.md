# Implementation Plan: make-wiki-command

## Task Overview

この実装計画は、`/ai-wiki/make`コマンドを拡張し、`wiki_structure.json`を読み込んで全ページのWikiコンテンツを生成する機能を実装します。

- [x] 1. コマンド定義の基本構造を更新する
- [x] 1.1 `<meta>`セクションに`description`と`argument-hint`を追加する
  - `description`に「`wiki_structure.json`を読み込んで全ページのWikiコンテンツを生成する」を設定
  - `argument-hint`に「[出力先ディレクトリ]」を設定（デフォルトは`wiki/`）
  - _Requirements: 8.6_

- [x] 1.2 `<background_information>`セクションにコマンドの目的と機能を説明する
  - `wiki_structure.json`の読み込みと全ページ生成の概要を説明
  - 出力先ディレクトリの指定方法を説明
  - 既存のページ生成指示との関係を説明
  - _Requirements: 8.1_

- [x] 2. 出力先ディレクトリの処理を実装する
- [x] 2.1 コマンド引数から出力先ディレクトリを取得する処理を追加する
  - 引数が指定されていない場合はデフォルト値`wiki/`を使用
  - ワークスペースルートからの相対パスとして扱う
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 2.2 出力先ディレクトリの存在確認と作成処理を追加する
  - ディレクトリが存在しない場合は`mkdir -p`で作成
  - ディレクトリ作成に失敗した場合はエラーメッセージを報告し、処理を中断
  - _Requirements: 2.3, 2.5_

- [x] 3. wiki_structure.jsonの読み込みと検証を実装する
- [x] 3.1 `.wiki/wiki_structure.json`ファイルの読み込み処理を追加する
  - `read_file`ツールを使用してJSONファイルを読み込む
  - ファイルが存在しない場合はエラーメッセージを報告し、処理を中断
  - _Requirements: 1.1, 1.2_

- [x] 3.2 JSONファイルの構文検証処理を追加する
  - Dockerコンテナ（`python:3-alpine`）を使用してJSON構文を検証
  - `init.md`のパターンを再利用（`docker run --rm -v $(pwd):/work -w /work python:3-alpine python -c "import json; json.load(open('.wiki/wiki_structure.json'))"`）
  - 検証に失敗した場合はエラーメッセージを報告し、処理を中断
  - _Requirements: 1.3, 1.4_

- [x] 3.3 JSONデータから必要な情報を抽出する処理を追加する
  - `sections`配列と`pages`配列を取得
  - `title`と`description`を取得
  - セクションIDとページIDの一意性を確認
  - _Requirements: 1.5, 1.6, 4.5_

- [x] 4. ページ生成ループ処理を実装する
- [x] 4.1 `pages`配列をループ処理して各ページを生成する処理を追加する
  - 各ページオブジェクトに対してWikiページを生成
  - ページ生成の成功/失敗を追跡
  - _Requirements: 3.1_

- [x] 4.2 各ページの`relevant_files`を読み込む処理を追加する
  - `read_file`ツールを使用して関連ファイルを読み込む
  - ファイルが存在しない場合はエラーメッセージを報告し、そのページの生成をスキップまたは利用可能なファイルのみを使用
  - _Requirements: 3.3, 3.9_

- [x] 4.3 既存のページ生成指示を使用してMarkdownコンテンツを生成する処理を追加する
  - 既存の`make.md`の`<instructions>`セクション内のページ生成指示を維持
  - 各ページの`title`をH1見出しとして使用
  - 各ページの`description`をページの説明として使用
  - `<details>`ブロックに使用した関連ファイルをリストアップ
  - Mermaidダイアグラム、テーブル、コードスニペットを含める（該当する場合）
  - コンテンツを日本語で生成
  - _Requirements: 3.2, 3.4, 3.5, 3.6, 3.7, 3.8_

- [x] 5. セクション構造の維持処理を実装する
- [x] 5.1 各ページの`parent_section`プロパティを確認する処理を追加する
  - `parent_section`が有効なセクションIDを参照していることを確認
  - 無効な参照の場合はエラーメッセージを報告し、処理を中断または無効な参照をスキップ
  - _Requirements: 4.3, 4.5_

- [x] 5.2 セクション構造をフラット構造で維持する処理を追加する
  - 各ページを`{page-id}.md`形式で出力先ディレクトリに保存（フラット構造）
  - セクション情報はページの`parent_section`プロパティで管理
  - `subsections`配列の階層構造は維持（将来の拡張として検討可能）
  - _Requirements: 4.1, 4.2, 4.4_

- [x] 6. ページ間リンクの生成処理を実装する
- [x] 6.1 各ページの`related_pages`プロパティに基づいてリンクを生成する処理を追加する
  - ページIDからファイルパスへのマッピング（`{page-id}` → `{page-id}.md`）
  - Markdownリンク構文（`[Link Text](page-id.md)`）で生成
  - リンク先のページが存在しない場合はリンクを生成するが、警告は表示しない
  - _Requirements: 5.1, 5.4, 5.5_

- [x] 6.2 セクション内の他のページへのリンクを生成する処理を追加する（オプション）
  - 同じ`parent_section`を持つ他のページへのリンクを生成
  - セクション構造に基づいたナビゲーションリンクの生成（実装方法による）
  - _Requirements: 5.2, 5.3_

- [x] 7. ファイル出力と構造化処理を実装する
- [x] 7.1 ファイル名生成ロジックを実装する
  - ページIDをそのままファイル名として使用（`{page-id}.md`）
  - 無効文字（`/`, `\`, `:`, `*`, `?`, `"`, `<`, `>`, `|`）が含まれる場合は`-`に置換
  - _Requirements: 6.2, 6.3_

- [x] 7.2 各ページをMarkdownファイルとして出力先ディレクトリに保存する処理を追加する
  - `write`ツールを使用してMarkdownファイルを書き込む
  - ファイルパスは`{output-dir}/{page-id}.md`形式
  - ファイル書き込みに失敗した場合はエラーメッセージを報告し、そのページの生成をスキップ（他のページの生成は継続）
  - _Requirements: 6.1, 6.5_

- [x] 8. エラーハンドリングと進捗報告を実装する
- [x] 8.1 エラーメッセージの生成と報告処理を追加する
  - エラーの種類（ファイルが見つからない、JSON構文エラー、ディレクトリ作成失敗など）に応じて適切なメッセージを日本語で生成
  - エラーメッセージを明確で理解しやすい形式で報告
  - _Requirements: 7.1, 7.2_

- [x] 8.2 部分的な失敗時の処理を実装する
  - 成功したページは保存し、失敗したページについてのみエラーを報告
  - 処理の完了時に、生成されたページ数と失敗したページ数（該当する場合）を報告
  - 生成されたファイルのパスをユーザーに報告
  - _Requirements: 7.3, 7.4, 7.5_

- [x] 9. コマンド定義の統合と最終確認を行う
- [x] 9.1 すべての処理ステップを`<instructions>`セクションに統合する
  - Step 1: 出力先ディレクトリの取得と確認
  - Step 2: `wiki_structure.json`の読み込みと検証
  - Step 3: セクション構造の解析
  - Step 4: 各ページの生成ループ（既存のページ生成指示を使用）
  - Step 5: ページ間リンクの生成
  - Step 6: ファイル出力と完了報告
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 9.2 コマンド定義の`<Tool Guidance>`セクションを更新する
  - 使用するツール（`read_file`, `write`, `run_terminal_cmd`, `list_dir`）を説明
  - Dockerコンテナの使用について説明
  - _Requirements: 8.1_

- [x] 9.3 コマンド定義の`<Output Description>`セクションを更新する
  - 生成されるMarkdownファイルの説明
  - 出力先ディレクトリの構造の説明
  - _Requirements: 8.1_

- [x] 9.4 コマンド定義の`<Safety & Fallback>`セクションを更新する
  - エラーハンドリングの説明
  - フォールバック動作の説明
  - _Requirements: 8.1_
